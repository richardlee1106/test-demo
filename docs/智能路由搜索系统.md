# 🚀 智能路由搜索系统 (Smart Search Router)

> MiroSpatial RAG v4.0 新特性：双轨搜索架构，简单查询秒级响应

---

## 📋 功能概述

新的搜索系统会根据用户输入**自动判断查询复杂度**，并路由到合适的处理路径：

| 查询类型 | 示例 | 处理路径 | 预期延迟 |
|---------|------|---------|---------|
| **简单名词** | 火锅、奶茶、学校 | 快速检索 → 直接渲染 | < 200ms |
| **复杂语义** | 南门附近有什么好吃的 | 自动打开 AI 助手 | 3-10s |

---

## 🏗️ 架构设计

```text
┌─────────────────────────────────────────────────────────────────┐
│                    用户在搜索框输入                              │
├─────────────────────────────────────────────────────────────────┤
│           前端 semanticSearch() 调用                            │
├────────────────────────────────┬────────────────────────────────┤
│    后端 /api/search/quick      │      后端判断 isComplex        │
├────────────────────────────────┼────────────────────────────────┤
│   【简单查询路径】              │     【复杂查询路径】            │
│   • 同义词扩展                  │     • 自动展开 AI 面板          │
│   • PostgreSQL 模糊匹配         │     • 填充输入框                │
│   • 空间边界过滤                │     • 自动发送消息              │
│   • 直接返回 POI                │     • LLM Pipeline 处理         │
│   • 渲染到 Map + TagCloud       │     • 结果渲染到 TagCloud       │
└────────────────────────────────┴────────────────────────────────┘
```

---

## 📁 涉及的文件改动

### 后端新增

| 文件 | 描述 |
|-----|------|
| `fastify-backend/routes/search.js` | 新增快速搜索路由模块 |
| `fastify-backend/services/database.js` | 新增 `quickSearch()` 方法 |
| `fastify-backend/server.js` | 注册 `/api/search` 路由 |

### 前端修改

| 文件 | 描述 |
|-----|------|
| `src/utils/aiService.js` | 新增 `quickSearch()`, 重构 `semanticSearch()` 返回值 |
| `src/App.vue` | 修改 `handleSearch()` 实现智能路由 |
| `src/components/AiChat.vue` | 新增 `autoSendMessage()` 暴露方法 |

---

## 🔧 API 接口

### GET `/api/search/quick`

快速名词搜索，绕过 LLM。

**Query 参数：**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| q | string | ✅ | 搜索关键词 |
| lat | number | ❌ | 中心纬度（用于距离排序） |
| lon | number | ❌ | 中心经度 |
| radius | number | ❌ | 搜索半径（米），默认 5000 |
| geometry | string | ❌ | WKT 格式空间边界 |
| limit | number | ❌ | 返回数量，默认 100 |

**响应示例：**

```json
{
  "success": true,
  "isComplex": false,
  "query": "火锅",
  "expandedTerms": ["火锅", "涮锅", "铜锅", "四川火锅"],
  "count": 45,
  "duration_ms": 32,
  "pois": [/* GeoJSON Features */]
}
```

### GET `/api/search/classify`

判断查询类型（调试用）

```json
// GET /api/search/classify?q=火锅
{ "query": "火锅", "isSimple": true, "recommendation": "quick_search" }

// GET /api/search/classify?q=南门附近有什么好吃的
{ "query": "南门附近有什么好吃的", "isSimple": false, "recommendation": "ai_assistant" }
```

---

## 🧠 复杂查询判断规则

后端 `/api/search/quick` 会检测以下模式，如果命中则返回 `isComplex: true`：

1. **长度限制**：超过 15 个字符
2. **空间词汇**：附近、周边、周围、旁边
3. **意图词汇**：有什么、有没有、哪里有、推荐、建议
4. **主观描述**：适合、好吃、好玩、便宜
5. **分析请求**：分析、比较、选择

---

## 📦 同义词扩展

内置 ~40 个标准类别的同义词表，覆盖：

- **餐饮**：火锅、奶茶、咖啡、烧烤、早餐、快餐、面食、小吃、甜点
- **生活**：超市、药店、银行、美容、酒店
- **交通**：地铁、公交、停车、加油
- **教育**：学校、幼儿园、培训
- **医疗**：医院、牙科
- **休闲**：健身、电影、KTV、网吧、公园

---

## ✅ 测试方法

### 简单查询测试（预期：快速渲染）

在搜索框输入：

- `火锅` → 应显示所有火锅相关 POI
- `奶茶` → 应显示茶饮店
- `地铁站` → 应显示地铁站点

### 复杂查询测试（预期：AI 面板自动打开）

在搜索框输入：

- `南门附近有什么好吃的` → 应自动打开 AI 面板并发送
- `适合约会的地方` → 应走 AI 路径
- `这个区域适合开什么店` → 应走 AI 路径

---

## 📅 更新日期

2026-01-14
