# ğŸŒ Spatial-RAG æŠ€æœ¯æ ˆå˜æ›´è¯´æ˜

> æ›´æ–°æ—¶é—´ï¼š2026-01-12

## æŠ€æœ¯æ ˆè°ƒæ•´

æ ¹æ®éœ€æ±‚ï¼Œå¯¹åŸæ–¹æ¡ˆè¿›è¡Œäº†ä»¥ä¸‹æŠ€æœ¯æ ˆæ›¿æ¢ï¼š

| åŸæŠ€æœ¯ | æ›¿æ¢ä¸º | è¯´æ˜ |
| ------ | ------ | ---- |
| FAISS | **Milvus** | æ›´å¼ºå¤§çš„åˆ†å¸ƒå¼å‘é‡æ•°æ®åº“ï¼Œæ”¯æŒæ··åˆæœç´¢ |
| Turf.js | **PostGIS** | æ•°æ®åº“çº§ç©ºé—´è®¡ç®—ï¼Œæ€§èƒ½æ›´å¥½ï¼ŒåŠŸèƒ½æ›´å®Œæ•´ |
| å†…å­˜ç´¢å¼• | **PostgreSQL** | æŒä¹…åŒ–å­˜å‚¨ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢ |

---

## ä¾èµ–æœåŠ¡æ¸…å•

### 1. PostgreSQL + PostGIS

- **ç”¨é€”**: ç©ºé—´æ•°æ®å­˜å‚¨ã€ç©ºé—´ç´¢å¼•ã€ç©ºé—´æŸ¥è¯¢ï¼ˆST_DWithinã€ST_Distance ç­‰ï¼‰
- **è¿æ¥ä¿¡æ¯**:
  - Host: `localhost`
  - Port: `5432`
  - User: `postgres`
  - Password: `123456`
  - Database: `tagcloud`

### 2. Milvus å‘é‡æ•°æ®åº“

- **ç”¨é€”**: POI è¯­ä¹‰ Embedding å­˜å‚¨ã€å‘é‡ç›¸ä¼¼åº¦æœç´¢
- **è¿æ¥ä¿¡æ¯**:
  - Host: `localhost`
  - Port: `19530`
  - Collection: `poi_embeddings`
- **å¯åŠ¨æ–¹å¼**: `docker-compose up -d`

### 3. æœ¬åœ° LLM (LM Studio)

- **ç”¨é€”**: æ„å›¾è§£æã€å›ç­”ç”Ÿæˆã€Embedding ç”Ÿæˆ
- **è¿æ¥ä¿¡æ¯**:
  - Base URL: `http://localhost:1234/v1`
  - LLM Model: `qwen3-4b-instruct-2507`
  - Embedding Model: `text-embedding-nomic-embed-text-v1.5`

---

## æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

```
fastify-backend/
â”œâ”€â”€ .env.example                    # ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ database.js                 # PostgreSQL + PostGIS æœåŠ¡
â”‚   â””â”€â”€ milvus.js                   # Milvus å‘é‡æ•°æ®åº“æœåŠ¡
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ spatial/
â”‚       â””â”€â”€ index.js                # ç©ºé—´æŸ¥è¯¢ API è·¯ç”±
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ import_poi_data.js          # POI æ•°æ®å¯¼å…¥è„šæœ¬
â””â”€â”€ server.js                       # ä¸»å…¥å£ï¼ˆå·²æ›´æ–°ï¼‰

scripts/
â””â”€â”€ sql/
    â””â”€â”€ init_database.sql           # PostgreSQL æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

docker-compose.yml                  # Milvus æœåŠ¡ Docker é…ç½®
```

---

## å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»º PostgreSQL æ•°æ®åº“

1. æ‰“å¼€ pgAdmin æˆ–å…¶ä»– PostgreSQL ç®¡ç†å·¥å…·
2. è¿æ¥åˆ°æœ¬åœ° PostgreSQL æœåŠ¡å™¨
3. åˆ›å»ºæ–°æ•°æ®åº“ `tagcloud`
4. åœ¨ `tagcloud` æ•°æ®åº“ä¸­æ‰§è¡Œ `scripts/sql/init_database.sql`

```sql
-- åœ¨ psql æˆ– pgAdmin ä¸­æ‰§è¡Œ
\c tagcloud
\i scripts/sql/init_database.sql
```

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ Milvus

```bash
cd d:\AAA_Edu\TagCloud\vite-project
docker-compose up -d
```

ç­‰å¾…çº¦ 1-2 åˆ†é’Ÿï¼Œè®¿é—® http://localhost:8000 æ‰“å¼€ Milvus Attu ç®¡ç†ç•Œé¢ã€‚

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
cd fastify-backend
copy .env.example .env
```

æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ `.env` æ–‡ä»¶ã€‚

### ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
cd fastify-backend
npm install pg @zilliz/milvus2-sdk-node latlon-geohash glob
```

### ç¬¬äº”æ­¥ï¼šå¯¼å…¥ POI æ•°æ®

```bash
cd fastify-backend
node scripts/import_poi_data.js
```

### ç¬¬å…­æ­¥ï¼šå¯åŠ¨åç«¯æœåŠ¡

```bash
npm run dev
```

---

## API æ¥å£

### 1. ç©ºé—´æŸ¥è¯¢

**POST** `/api/spatial/query`

```json
{
  "query": "æ­¦ç†å·¥å—é—¨é™„è¿‘500ç±³å†…æœ‰å“ªäº›éº¦å½“åŠ³ï¼Ÿ"
}
```

**å“åº”**:
```json
{
  "success": true,
  "center": { "lon": 114.359, "lat": 30.517 },
  "intent": {
    "place_name": "æ­¦æ±‰ç†å·¥å¤§å­¦",
    "gate": "å—é—¨",
    "radius_m": 500,
    "category": "éº¦å½“åŠ³"
  },
  "total": 3,
  "results": [
    {
      "id": 1,
      "name": "éº¦å½“åŠ³(æ­¦æ±‰æœªæ¥åŸé¤å…)",
      "address": "çç‹®å—è·¯147å·...",
      "distance": 320,
      "coordinates": [114.353, 30.525]
    }
  ]
}
```

### 2. ç©ºé—´å¯¹è¯

**POST** `/api/spatial/chat`

```json
{
  "query": "å…‰è°·å¹¿åœºé™„è¿‘æœ‰ä»€ä¹ˆå¥½åƒçš„å¿«é¤åº—ï¼Ÿ"
}
```

**å“åº”**: åŒ…å«ç»“æ„åŒ–ç»“æœ + LLM è‡ªç„¶è¯­è¨€å›ç­”

### 3. æœåŠ¡çŠ¶æ€

**GET** `/api/spatial/status`

```json
{
  "postgis": true,
  "milvus": true
}
```

---

## æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·æŸ¥è¯¢
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM æ„å›¾è§£æ          â”‚
â”‚   (Qwen3 JSON Mode)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é”šç‚¹åæ ‡è§£æ          â”‚
â”‚   (landmarks è¡¨)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostGIS ç©ºé—´è¿‡æ»¤      â”‚
â”‚   ST_DWithin()          â”‚
â”‚   + å±æ€§è¿‡æ»¤            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Milvus è¯­ä¹‰æ’åº       â”‚
â”‚   (æœ‰è¯­ä¹‰æŸ¥è¯¢æ—¶)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM ç”Ÿæˆå›ç­”          â”‚
â”‚   (Top N ç»“æœ)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ³¨æ„äº‹é¡¹

1. **Milvus æ˜¯å¯é€‰çš„**ï¼šå¦‚æœ Milvus è¿æ¥å¤±è´¥ï¼Œç³»ç»Ÿä¼šé™çº§ä¸ºä»…ä½¿ç”¨ PostGIS ç©ºé—´è¿‡æ»¤ï¼Œä¸å½±å“åŸºæœ¬åŠŸèƒ½ã€‚

2. **PostGIS æ˜¯å¿…éœ€çš„**ï¼šç©ºé—´æŸ¥è¯¢çš„æ ¸å¿ƒåŠŸèƒ½ä¾èµ– PostGISï¼Œå¿…é¡»ç¡®ä¿æ•°æ®åº“æ­£ç¡®åˆå§‹åŒ–ã€‚

3. **Embedding æ¨¡å‹**ï¼šç¡®ä¿ LM Studio ä¸­åŠ è½½äº† `text-embedding-nomic-embed-text-v1.5` æˆ–ç±»ä¼¼çš„ embedding æ¨¡å‹ã€‚

4. **åæ ‡ç³»**ï¼šæ‰€æœ‰åæ ‡ä½¿ç”¨ WGS84 (EPSG:4326)ã€‚

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] åˆ›å»ºå‰ç«¯ç©ºé—´æŸ¥è¯¢ç»„ä»¶
- [ ] é”šç‚¹çŸ¥è¯†åº“è‡ªåŠ¨æ‰©å……ï¼ˆä» POI æ•°æ®æå–çƒ­é—¨åœ°æ ‡ï¼‰
- [ ] è¯„åˆ†å­—æ®µæ”¯æŒï¼ˆå¦‚æœæœ‰è¯„åˆ†æ•°æ®æºï¼‰
- [ ] GraphRAG æ‰©å±•ï¼ˆå¤æ‚è·¯çº¿æ¨ç†ï¼‰
