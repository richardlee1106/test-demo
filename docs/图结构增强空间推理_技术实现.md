# 图结构增强空间推理 - 技术实现文档

> 文档版本: v1.0  
> 更新日期: 2026-01-25  
> 状态: **已实现 (Phase 1)**

---

## 1. 概述

本方案在现有 **PostGIS + H3** 架构基础上，引入**图结构分析**能力，使 Spatial RAG 从单纯的"空间检索+生成"进化为 **"空间检索 + 图推理 + 语义生成"** 三位一体的智能分析系统。

### 1.1 核心价值

| 场景 | 传统方案 | 图增强方案 |
|------|---------|-----------|
| 区域核心识别 | 按 POI 密度排序 | PageRank + 连通度综合评分 |
| 代表点选择 | 几何密度采样 | 基于网络拓扑的枢纽/桥梁优先 |
| 功能区划分 | H3 网格统计 | 社区检测算法 (标签传播) |
| 可达性分析 | 简单距离计算 | 介数中心性 + 路径分析 |

### 1.2 架构集成位置

```
┌──────────────────────────────────────────────────────────────┐
│ 阶段1: Planner (规划者)                                       │
│   ✅ 新增 need_graph_reasoning 判定逻辑                        │
│   ✅ 关键词: 可达性/枢纽/连接/网络结构/生活圈                    │
├──────────────────────────────────────────────────────────────┤
│ 阶段2: Executor (执行者)                                      │
│   ✅ 新增 execGraphMode() 图推理执行模式                       │
│   ✅ 调用 graph.js 服务进行 PageRank/社区检测                   │
│   ✅ 综合评分: α*Spatial + β*Functional + γ*Semantic + δ*Graph │
├──────────────────────────────────────────────────────────────┤
│ 阶段3: Writer (生成者)                                        │
│   ✅ 图分析结果格式化输出 (枢纽/桥梁/社区)                      │
│   ✅ System Prompt 增加图分析解读能力                          │
└──────────────────────────────────────────────────────────────┘
```

---

## 2. 技术实现

### 2.1 图服务模块 (`services/graph.js`)

#### 核心类: `H3SpatialGraph`

```javascript
class H3SpatialGraph {
  // 节点: Map<h3Index, { id, count, mainCategory, pois, pageRank, betweenness, communityId }>
  // 边: Map<h3Index, Set<h3Index>> (邻接表，基于 H3 相邻关系)
  
  buildFromPOIs(pois, resolution)  // 从 POI 构建图
  computePageRank()                 // PageRank 算法
  computeBetweenness()              // 介数中心性 (采样近似)
  detectCommunities()               // 标签传播社区检测
  generateSummary()                 // 生成结构化摘要
}
```

#### 图算法实现

| 算法 | 复杂度 | 用途 |
|------|--------|------|
| PageRank | O(E × iter) | 识别区域核心枢纽 |
| Betweenness (采样) | O(V × E) | 识别桥梁连接节点 |
| Label Propagation | O(E × iter) | 社区/功能区划分 |

#### 输出结构

```javascript
{
  global: {
    totalGrids: 45,          // H3 网格总数
    totalConnections: 112,   // 边总数
    avgConnectivity: 4.96    // 平均连通度
  },
  hubs: [                    // 枢纽节点 (Top 5)
    { h3Index, lat, lon, poiCount, mainCategory, pageRank, representativePOI }
  ],
  bridges: [                 // 桥梁节点 (Top 5)
    { h3Index, lat, lon, poiCount, mainCategory, betweenness, representativePOI }
  ],
  communities: [             // 功能社区 (Top 6)
    { id, gridCount, totalPOIs, dominantCategory, categoryRatio }
  ],
  insights: [                // 自然语言洞察
    { type: 'hub', text: '区域核心枢纽位于「武汉大学」附近...', importance: 0.92 }
  ]
}
```

### 2.2 Planner 增强

#### 图推理触发关键词

```javascript
const GRAPH_REASONING_KEYWORDS = [
  // 网络/可达性
  '可达性', '交通网络', '路网', '连通性', '通达', '便利度',
  // 枢纽/节点
  '枢纽', '核心节点', '中心节点', '交通中心', '商业中心', '核心区',
  // 路径/连接
  '路径', '连接', '串联', '贯穿', '衔接', '辐射',
  // 结构/拓扑
  '结构', '网络结构', '空间结构', '拓扑', '布局',
  // 关系
  '关联', '协同', '共生', '聚集效应', '生态圈', '生活圈'
]
```

#### 双保险检测机制

1. **LLM 判断**: System Prompt 指导 LLM 输出 `need_graph_reasoning: true`
2. **后端关键词检测**: 即使 LLM 未识别，后端仍会检测关键词并强制开启

### 2.3 Executor 图推理模式

```javascript
async function execGraphMode(plan, frontendPOIs, options) {
  // 1. 首先执行聚合分析获取候选数据
  const aggregatedResult = await execAggregatedAnalysisMode(plan, ...)
  
  // 2. 动态导入图服务
  const graphService = await import('../../services/graph.js')
  
  // 3. 从数据库获取更多 POI 用于图分析 (limit: 2000)
  const poisForGraph = await searchFromDatabase(...)
  
  // 4. 执行图推理
  const graphResult = graphService.analyzeGraph(poisForGraph, { resolution: 9 })
  
  // 5. 基于图分析结果增强 POI 选择
  // 综合评分: FinalScore = α*Spatial + β*Functional + γ*Semantic + δ*GraphCentrality
  const enhancedPOIs = aggregatedResult.pois.map(poi => {
    let graphBonus = 0
    if (hubH3Indices.has(poiH3)) graphBonus = 0.3  // 枢纽加分
    if (bridgeH3Indices.has(poiH3)) graphBonus = 0.2  // 桥梁加分
    return { ...poi, enhanced_score: poi.score + graphBonus }
  })
  
  return { mode: 'graph_analysis', graph_analysis: graphResult, pois: enhancedPOIs }
}
```

### 2.4 Writer 图分析输出

Writer 会将图分析结果格式化为自然语言：

```markdown
🔗 **空间网络结构分析**:

> 覆盖 45 个空间单元，形成 112 个连接关系，平均连通度 4.96

**核心枢纽区域** (高中心性节点):
1. 「光谷广场」区域 - 商业聚集地，辐射强度 92%
2. 「武汉大学」区域 - 教育聚集地，辐射强度 78%

**功能连接点** (桥梁节点):
- 「珞狮路」附近 - 连接度 65%，起到功能衔接作用

**业态功能区块**:
- 区块 1: 以「商业」为主 (45%)，覆盖 12 个网格
- 区块 2: 以「教育」为主 (38%)，覆盖 8 个网格

**网络拓扑洞察**:
- 区域核心枢纽位于「光谷广场」附近，聚集了 156 个 POI，主要业态为商业。
- 检测到 3 个功能区块，最大区块以「商业」为主，占比 45%。
```

---

## 3. 使用示例

### 3.1 触发图推理的查询

以下查询会自动触发图推理通道：

- "分析这片区域的**交通可达性**"
- "哪些地方是区域的**核心枢纽**？"
- "这片区域的**空间结构**是怎样的？"
- "评估当前视野的**商业连接**情况"
- "这里有没有形成明显的**生活圈**？"

### 3.2 QueryPlan 输出示例

```json
{
  "query_type": "area_analysis",
  "intent_mode": "macro_overview",
  "need_graph_reasoning": true,
  "aggregation_strategy": {
    "enable": true,
    "method": "h3",
    "resolution": 9
  },
  "categories": ["公交站", "地铁站", "停车场"],
  "semantic_query": "交通便利度 交通枢纽"
}
```

---

## 4. 性能考量

| 指标 | 典型值 | 说明 |
|------|--------|------|
| 图构建 | 50-100ms | 1000 POI → ~100 H3 节点 |
| PageRank | 20-50ms | 20 次迭代收敛 |
| 介数中心性 | 100-200ms | 30 源节点采样 |
| 社区检测 | 30-80ms | 10 次迭代 |
| **总耗时** | **200-400ms** | 纯内存计算 |

---

## 5. 后续演进 (Phase 2)

### 5.1 真实路网集成

```sql
-- 导入 OSM 路网数据
CREATE TABLE road_network (
  id SERIAL PRIMARY KEY,
  geom GEOMETRY(LINESTRING, 4326),
  road_type VARCHAR(50),
  length_m FLOAT
);

-- 构建基于路网的可达性图
```

### 5.2 时序图分析

- 早高峰/晚高峰的枢纽变化
- 节假日 vs 工作日的社区结构差异

### 5.3 知识图谱融合

- POI 之间的语义关系（如：学校 → 培训机构 → 文具店）
- 业态协同效应量化

---

## 6. 文件清单

| 文件 | 修改类型 | 说明 |
|------|----------|------|
| `services/graph.js` | 新建 | H3 空间拓扑图服务 |
| `routes/ai/planner.js` | 修改 | 添加图推理判定逻辑 |
| `routes/ai/executor.js` | 修改 | 实现 execGraphMode() |
| `routes/ai/writer.js` | 修改 | 图分析结果格式化 |

---

## 7. 总结

通过将 H3 网格与 POI 节点图谱化，Planner 可按需调用图算法来衡量空间节点的重要性。这使得 Spatial RAG 具备了：

1. **结构化空间认知** - 不仅知道"有什么"，还知道"怎么连接"
2. **拓扑敏感的推荐** - 枢纽区域的 POI 获得更高权重
3. **可解释的分析报告** - "A点在区域网络中起到枢纽作用"

系统从单纯的"空间检索+生成"进化为**"空间检索 + 图推理 + 语义生成"**，在区域画像与选址任务上具备更强的严谨性与结构化解释力。
