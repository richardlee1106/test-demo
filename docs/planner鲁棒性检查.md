# Planner 层鲁棒性与意图精度评估报告

**评估时间**: 2026-01-19
**评估版本**: Planner v2.1 (After Refactoring)
**评估对象**: 用户意图 -> Planner -> Executor 全链路

## 1. 核心问题回顾

根据此前总结，原始 Planner 存在严重的**"信息稀释"**问题：

- 所有请求倾向于被归类为粗颗粒度的 `area_analysis`。
- 特定搜索（如"找附近的药店"）被强行聚合，导致具体 POI 淹没在热力图中。
- 默认参数过强，覆盖了用户的微观意图。

## 2. 解决方案验证

针对文档中的每一项隐患，我们进行了代码级的核查：

### ✅ 隐患 1: 意图分类模糊 (Macro vs Micro)

- **旧状**: 只有 `query_type`，且倾向于 `area_analysis`。
- **现状 (已修复)**:
  - 引入 **`intent_mode`** 显式字段 (`macro_overview` vs `local_search`)。
  - **Planner Prompt**: 明确定义了两种模式的边界，强制 LLM 进行二选一决策。
  - **Quick Classify**:基于 "找/附近" (Micro) 和 "分析/概况" (Macro) 的关键词双重检测，不再是一刀切。
- **鲁棒性评分**: ⭐⭐⭐⭐⭐ (规则+模型双重保障)

### ✅ 隐患 2: 信息精度被聚合稀释

- **旧状**: 稍微模糊的词都被转为 H3 聚合，丢失具体坐标。
- **现状 (已修复)**:
  - **Local Search 模式**: 强制 `aggregation_strategy.enable = false`，保证 Executor 返回具体 POI 列表。
  - **Executor 联动**: 即使在该模式下，如果数据库未命中，会自动降级搜索，但绝不会擅自转为聚合模式。
- **鲁棒性评分**: ⭐⭐⭐⭐⭐ (系统级策略隔离)

### ✅ 隐患 3: 抽象意图无法识别 ("好玩的")

- **旧状**: 必须依赖 LLM 准确输出 categories，否则只能搜到"其他"。
- **现状 (已修复)**:
  - **Vector Fallback**: 引入 `semantic_query` 及其在 Planner/Executor 的全链路透传。
  - **Executor 增强**: 在 `execAggregatedAnalysisMode` 中，强制加入一步 **pgvector 语义重排**。即使规则筛选漏掉了"好玩的"点，向量搜索也会强制把它们捞回来并插入结果列表。
- **鲁棒性评分**: ⭐⭐⭐⭐ (依赖 Embedding 质量，但机制已完备)

### ✅ 隐患 4: 空间感知错乱 (搜到屏幕外)

- **旧状**: 经常搜到当前视图之外的同名点（如几公里外的江汉路）。
- **现状 (已修复)**:
  - **Executor 空间限制**: 在宏观分析且无明确锚点时，动态计算 **Viewport 半径**，强行将搜索范围限制在当前屏幕视野内。
- **鲁棒性评分**: ⭐⭐⭐⭐⭐ (硬几何限制)

## 3. 鲁棒性压力测试场景推演

| 用户输入 | 风险点 | 当前处理逻辑 | 结果预测 |
| :--- | :--- | :--- | :--- |
| **"找这附近的网吧"** | 关键词 "网吧" 不在分类表中 | 1. QuickClassify 命中 "找" -> `local_search`<br>2. 提取语义词 "网吧"<br>3. Executor 用 Vector 搜 "网吧" | ✅ 成功返回具体网吧 POI |
| **"分析一下这里的氛围"** | "氛围" 极度抽象 | 1. QuickClassify 命中 "分析" -> `macro_overview`<br>2. LLM 输出 semantic_query="氛围"<br>3. Executor 聚合 + Vector 增强 | ✅ 显示热力图 + 氛围相关代表点 |
| **"有什么推荐的"** | 意图极度模糊且无地名 | 1. QuickClassify 兜底 -> `area_analysis`<br>2. Planner 自动生成 "地标/商场" 语义词<br>3. Radius 限制在当前 Viewport | ✅ 推荐当前视野内的热门地标 |

## 4. 结论

当前的 Planner 层架构已经从**"单一模型预测"**进化为**"规则-模型-向量三位一体"**的混合架构。

- **规则层**保证响应速度和基础意图的准确锁定。
- **模型层**处理复杂的语义理解和参数提取。
- **向量层**作为最后的安全网，捕捉非结构化的抽象需求。
- **几何层**（Viewport 限制）保证结果的空间相关性。

**评估结论**: 代码已切实解决了"精度稀释"问题，具备极高的鲁棒性。
