# 🧠 Spatial-RAG 系统架构详解

> **Spatial-RAG (空间感知检索增强生成)** —— 让 AI 真正理解"附近500米"

---

## 📋 目录

1. [核心问题](#核心问题)
2. [解决方案：分工协作](#解决方案分工协作)
3. [数据流转架构](#数据流转架构)
4. [各组件职责](#各组件职责)
5. [与传统 RAG 的对比](#与传统-rag-的对比)
6. [一句话总结](#一句话总结)

---

## 核心问题

我们想让 AI 能回答这样的问题：

> **"武汉理工大学南门附近 500 米内有哪些好吃的咖啡馆？"**

传统的 LLM 做不到这一点，因为：

| 问题 | 原因 |
|------|------|
| LLM 不知道"武理工南门"在哪里 | 没有经纬度概念 |
| LLM 不会计算"500米内" | 没有数学空间计算能力 |
| LLM 不知道你的 POI 数据库里有什么店 | 没有实时数据访问能力 |

---

## 解决方案：分工协作

**核心思想：不要让 LLM 做它不擅长的事，而是让每个组件做自己擅长的事。**

### 完整查询流程

```text
┌─────────────────────────────────────────────────────────────────────────┐
│                        用户问题                                          │
│       "武理工南门附近500米内有哪些评分高的咖啡馆？"                        │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  🤖 LLM (Qwen3)  →  擅长：理解自然语言                                   │
│                                                                         │
│  输入: "武理工南门附近500米内有哪些评分高的咖啡馆？"                       │
│  输出: {                                                                │
│    "place_name": "武汉理工大学",                                         │
│    "gate": "南门",                                                       │
│    "radius_m": 500,                                                     │
│    "category": "咖啡馆"                                                  │
│  }                                                                      │
│                                                                         │
│  ✅ LLM 做的事：把自然语言变成结构化的查询参数                             │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  📍 地理编码器 (Geocoder)  →  擅长：把地名变成坐标                        │
│                                                                         │
│  输入: "武汉理工大学" + "南门"                                            │
│  查找顺序:                                                               │
│    1️⃣ 你的 POI 库（10万+ 店铺）→ 找不到                                   │
│    2️⃣ landmarks 缓存表 → 找不到                                          │
│    3️⃣ 高德地图 API → 找到！                                              │
│  输出: [114.359, 30.517] (经度, 纬度)                                    │
│                                                                         │
│  ✅ 解决问题：任何地名都能转成坐标                                         │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  🗺️ PostGIS 空间数据库  →  擅长：数学计算（距离、范围）                   │
│                                                                         │
│  SQL: SELECT * FROM pois                                                │
│        WHERE ST_DWithin(geom, 中心点, 500米)  -- 500米范围内             │
│          AND type LIKE '%咖啡馆%'              -- 类别过滤               │
│        ORDER BY distance;                      -- 按距离排序             │
│                                                                         │
│  输出: [                                                                │
│    {name: "瑞幸咖啡(武理工店)", distance: 120m, address: "..."},         │
│    {name: "星巴克(珞狮路店)", distance: 280m, address: "..."},           │
│    {name: "Manner Coffee", distance: 450m, address: "..."},             │
│    ... (可能还有更多)                                                    │
│  ]                                                                      │
│                                                                         │
│  ✅ PostGIS 做的事：精确的空间计算（LLM 做不到的事）                       │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  🔍 Milvus 向量数据库 (可选)  →  擅长：语义相似度匹配                     │
│                                                                         │
│  场景：用户说 "环境安静适合学习的"                                        │
│                                                                         │
│  做法:                                                                   │
│    1. 把 "环境安静适合学习" 变成向量 [0.12, -0.34, 0.56, ...]            │
│    2. 和所有咖啡馆的描述向量做相似度计算                                   │
│    3. 按相似度排序                                                       │
│                                                                         │
│  ✅ Milvus 做的事：理解语义偏好（比如"安静""网红""性价比高"）              │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  🤖 LLM (Qwen3)  →  擅长：组织自然语言回答                               │
│                                                                         │
│  输入: 前面筛选出的 Top 5 咖啡馆数据（很少的 token！）                     │
│  输出:                                                                   │
│    "武理工南门附近500米内有以下推荐的咖啡馆：                              │
│     1. 瑞幸咖啡(武理工店) - 最近，仅120米，价格实惠                        │
│     2. 星巴克(珞狮路店) - 280米，环境好适合办公                            │
│     3. Manner Coffee - 450米，精品咖啡                                   │
│     推荐您去瑞幸，距离最近步行2分钟即可到达。"                              │
│                                                                         │
│  ✅ LLM 做的事：把结构化数据变成友好的自然语言回答                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 数据流转架构

### 数据从原始文件到各个存储的流转过程

```text
┌──────────────────────────────────────────────────────────────────────────┐
│                          你的原始数据                                     │
│                                                                          │
│  📁 public/split_data/**/*.geojson                                       │
│  ├── 餐饮服务/快餐厅/麦当劳.geojson                                       │
│  ├── 餐饮服务/咖啡厅/星巴克.geojson                                       │
│  └── ... (10万+ POI)                                                     │
└──────────────────────────────────────┬───────────────────────────────────┘
                                       │
                                       ▼  导入脚本
                                       │  (import_poi_data.js)
                                       │
        ┌──────────────────────────────┼──────────────────────────────────┐
        │                              │                              │
        ▼                              ▼                              ▼
┌───────────────────┐  ┌───────────────────────────┐  ┌────────────────────┐
│  PostgreSQL       │  │  PostgreSQL               │  │  Milvus            │
│  + PostGIS        │  │  landmarks 表              │  │  向量数据库         │
│                   │  │  (缓存表)                  │  │                    │
│  pois 表          │  │                           │  │  poi_embeddings    │
│  ├── id           │  │  ├── 武汉理工大学南门      │  │  ├── id            │
│  ├── name         │  │  ├── 光谷广场站            │  │  ├── embedding     │
│  ├── address      │  │  └── (自动缓存)           │  │  │   [0.12, -0.3,..]│
│  ├── type         │  │                           │  │  └── name          │
│  ├── geom (坐标)  │  └───────────────────────────┘  │                    │
│  ├── geohash      │                                 │  用于语义搜索       │
│  └── search_text  │  用于锚点解析                    │                    │
│                   │                                 └────────────────────┘
│  用于空间查询      │
└───────────────────┘
```

### 各存储的数据结构

#### 1. PostgreSQL pois 表

```sql
CREATE TABLE pois (
    id              SERIAL PRIMARY KEY,
    poiid           VARCHAR(50) UNIQUE,      -- 高德 POI ID
    name            VARCHAR(255),            -- 名称，如"麦当劳(武汉未来城餐厅)"
    address         TEXT,                    -- 地址
    type            VARCHAR(255),            -- 类型，如"餐饮服务;快餐厅;麦当劳"
    category_big    VARCHAR(100),            -- 大类：餐饮服务
    category_mid    VARCHAR(100),            -- 中类：快餐厅
    category_small  VARCHAR(100),            -- 小类：麦当劳
    geom            GEOMETRY(POINT, 4326),   -- 空间点（WGS84 坐标）
    geohash         VARCHAR(12),             -- GeoHash 编码
    search_text     TEXT                     -- 搜索文本（名称+地址+类型）
);
```

#### 2. PostgreSQL landmarks 表（缓存）

```sql
CREATE TABLE landmarks (
    id              SERIAL PRIMARY KEY,
    name            VARCHAR(255),            -- 名称，如"武汉理工大学南门"
    alias           VARCHAR(255)[],          -- 别名数组，如['武理工南门']
    type            VARCHAR(50),             -- 类型：university/metro/landmark
    geom            GEOMETRY(POINT, 4326)    -- 位置坐标
);
```

#### 3. Milvus poi_embeddings 集合

```json
{
  "id": "poi_12345",
  "poi_id": 12345,
  "name": "星巴克(珞狮路店)",
  "embedding": [0.12, -0.34, 0.56, ...]  // 768维向量
}
```

---

## 各组件职责

| 组件 | 职责 | 为什么需要它 |
|------|------|-------------|
| **LLM (Qwen3)** | 理解自然语言，提取意图 | 用户说"南门附近500米"，需要理解这是空间查询 |
| **PostgreSQL + PostGIS** | 存储 POI 数据，做空间计算 | 精确计算"500米内"需要数学，LLM 做不到 |
| **Geocoder (地理编码)** | 把地名转成坐标 | "武汉理工大学南门" → [114.359, 30.517] |
| **Milvus (可选)** | 语义相似度搜索 | "环境安静适合学习" 这种模糊偏好需要向量匹配 |
| **GeoHash** | 快速空间过滤 | 先粗筛"wtmk5*"区域的 POI，再精确计算距离 |

### 组件之间的调用关系

```text
用户请求
    │
    ▼
┌─────────────────┐
│  Fastify 后端   │
│  /api/spatial   │
└────────┬────────┘
         │
    ┌────┴────┬──────────────┬───────────────┐
    │         │              │               │
    ▼         ▼              ▼               ▼
┌───────┐ ┌────────┐ ┌─────────────┐ ┌─────────────┐
│  LLM  │ │Geocoder│ │  PostGIS    │ │   Milvus    │
│ Qwen3 │ │  服务  │ │  空间查询    │ │  语义搜索   │
└───────┘ └────────┘ └─────────────┘ └─────────────┘
    │         │              │               │
    └────┬────┴──────────────┴───────────────┘
         │
         ▼
    返回给用户
```

---

## 与传统 RAG 的对比

| 特性 | 传统 RAG | Spatial-RAG |
|------|---------|-------------|
| **数据处理** | 把所有 POI 转成文本 embedding | 文本语义 + 空间坐标分开处理 |
| **空间查询** | "500米内"靠模糊匹配 | "500米内"用 PostGIS 精确数学计算 |
| **Token 消耗** | 发送大量 POI 给 LLM | 先过滤，只发 Top 10 给 LLM |
| **准确性** | 回答不准确，可能出现幻觉 | 回答精确，基于真实数据 |
| **扩展性** | 数据量大时性能差 | 利用数据库索引，性能好 |

### 具体对比示例

**问题**: "武理工南门附近500米内有什么咖啡馆？"

| 维度 | 传统 RAG | Spatial-RAG |
|------|---------|-------------|
| **做法** | 把 10 万 POI 描述都 embedding，查询时做向量相似度 | 先用 PostGIS 过滤 500 米内的 POI，再做类别匹配 |
| **候选集** | 可能返回 "成都的咖啡馆"（语义相似但位置不对） | 只返回真正在 500 米内的咖啡馆 |
| **Token** | 可能需要把几百个 POI 发给 LLM | 只发 5-10 个最相关的 POI |
| **结果** | 可能出现幻觉 | 精确且有距离信息 |

---

## 一句话总结

> **让 LLM 做它擅长的（理解语言、组织回答），让数据库做它擅长的（空间计算、数据过滤），最后把结果交给 LLM 组织成自然语言。**

---

## 技术栈一览

| 层级 | 技术 | 作用 |
|------|------|------|
| **前端** | Vue 3 + Vite | 用户界面 |
| **后端** | Fastify | API 服务 |
| **LLM** | Qwen3 (本地 LM Studio) | 意图解析 + 回答生成 |
| **空间数据库** | PostgreSQL + PostGIS | POI 存储 + 空间查询 |
| **向量数据库** | Milvus (可选) | 语义搜索 |
| **地理编码** | 高德 API + POI 库 | 地名 → 坐标 |

---

## 相关文件

| 文件 | 说明 |
|------|------|
| `fastify-backend/services/database.js` | PostGIS 数据库服务 |
| `fastify-backend/services/milvus.js` | Milvus 向量数据库服务 |
| `fastify-backend/services/geocoder.js` | 地理编码服务 |
| `fastify-backend/routes/spatial/index.js` | 空间查询 API |
| `fastify-backend/scripts/import_poi_data.js` | POI 数据导入脚本 |
| `scripts/sql/init_database.sql` | 数据库初始化脚本 |

---

> 📅 文档创建时间：2026-01-12  
> 📝 作者：TagCloud 开发团队
