# 🧠 MiroSpatial RAG v4.0 系统架构详解

> **MiroSpatial RAG (空间感知检索增强生成)** —— 融合地理信息系统 (GIS) 与大语言模型 (LLM)，构建具备"空间决策力"的新一代 RAG 架构。

---

## 📋 目录

1. [核心挑战](#核心挑战)
2. [三阶段决策流水线 (Pipeline)](#三阶段决策流水线)
3. [核心组件：Executor 决策流](#核心组件executor-决策流)
4. [全域感知与区域画像](#全域感知与区域画像)
5. [数据流转与存储](#数据流转与存储)
6. [MiroSpatial 4.0 交互特性](#mirospatial-40-交互特性)

---

## 核心挑战

传统的 RAG 架构基于向量相似度，在面对空间查询时存在三大盲区：

1. **地名无感**：不知道"武理工南门"的具体经纬度。
2. **空间无能**：无法理解"500米半径"或"多边形选区"的几何限制。
3. **效率陷阱**：将数十万 POI 文本化会导致 Token 爆炸且检索极慢。

---

## 三阶段决策流水线

**MiroSpatial RAG** 采用解耦的三阶段架构，确保每一步都由最擅长的组件执行：

### 1. 🤖 Stage 1: Planner (意图解析)

* **输入**：自然语言问题 + 当前地图视野 (Spatial Context)。
* **职责**：解析查询意图，生成结构化 JSON 计划。
* **输出**：`QueryPlan` (包含锚点解析、类别提取、语义偏好、空间范围等)。

### 2. ⚡ Stage 2: Executor (执行引擎)

* **职责**：执行复杂的“空间+语义”混合检索。
* **决策流**：
  * **坐标转换**：将地名锚点转化为 [Lon, Lat]。
  * **空间指纹**：计算 GeoHash 签名，实现秒级空间预过滤。
  * **动态路由**：检测到类型错配或空间越界时，自动在“内存数据检索”与“PostGIS 全库检索”间切换。
  * **语义精排**：结合 Milvus 向量数据库对初筛结果进行语义排序。
* **输出**：精简后的 POI 实体列表 + 区域分析数据。

### 3. ✍️ Stage 3: Writer (回答生成)

* **职责**：将 Executor 返回的结构化数据重组为自然语言。
* **输出**：带有地理逻辑的专业解答，并将关键实体标记为交互点。

---

## 核心组件：Executor 决策流

这是 MiroSpatial 的大脑，其逻辑流程如下：

```text
┌────────────────┐      ┌─────────────────────────┐      ┌──────────────────┐
│  收到 QueryPlan │ ───> │  解析锚点/视野中心地标     │ ───> │  计算 GeoHash 指纹  │
└────────────────┘      └─────────────────────────┘      └──────────────────┘
                                                                  │
                                                                  ▼
┌──────────────────┐    ┌─────────────────────────┐      ┌──────────────────┐
│   返回压缩结果     │ <── │  Milvus 语义精排 (可选)  │ <─── │   空间 + 类别过滤   │
│   (Writer 使用)   │      └─────────────────────────┘      │   (PostGIS/DB)   │
└──────────────────┘                                     └──────────────────┘
```

---

## 全域感知与区域画像

**MiroSpatial 4.0** 引入了超越 POI 搜索的“指挥级”分析能力：

* **全域感知 (Global Context)**：当用户进行区域分析模式时，Executor 不再只回传 POI 列表，而是通过 PostGIS 执行聚合统计。
* **区域画像 (Area Profile)**：
  * **类别分布**：分析选中范围内各行业的密度。
  * **代表地标**：自动识别并回传该区域的核心地标（地铁、大学等）。
  * **语义特征**：结合向量特征提取该区域的群体性语义标签（如“高消费区”“学区”）。

---

## 数据流转与存储

### 1. 空间持久层 (PostGIS)

存储 10万+ 原始 POI 及其几何信息 (`GEOMETRY`)，负责高效的范围查询和缓冲区计算。

### 2. 语义持久层 (Milvus)

存储 POI 名称与描述的 Embedding，负责处理“有氛围感”、“适合看书”等无法被传统分类库覆盖的模糊意图。

### 3. 锚点缓存 (Landmarks)

预存主要地标（校门、商场、站台）的经纬度，减少对高德等外部 API 的依赖，提升系统响应速度。

---

## MiroSpatial 4.0 交互特性

MiroSpatial 不仅仅是对话框，它是一个**全链路联动系统**：

1. **AI-TagCloud 协同**：AI 识别的 POI 实体会直接驱动右侧“标签云”重新分布。
2. **空间选区联动**：多边形、圆形选区直接作为 `SpatialContext` 参与 Executor 过滤。
3. **三列指挥面板**：
    * **左侧 (Map)**：空间可视化与实时态势。
    * **中间 (Tag Cloud)**：数据语义分布与集群感知。
    * **右侧 (AI)**：深度推理、多轮问答与分析报告。

---

> 📡 **技术栈一览**：Vue 3 / Fastify / PostgreSQL(PostGIS) / Milvus / Qwen3  
> 🕒 **文档版本**：v4.0 (beta)  
> 📅 **更新时间**：2026-01-14
