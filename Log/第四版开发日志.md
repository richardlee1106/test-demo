# 开发日志（第四版）：交互增强与多维筛选

**时间**：2025-12-07
**主题**：模糊查询、布局卷帘调整、POI 多类叠加筛选

本文档记录了在第三版基础上，针对用户提出的交互增强需求进行的开发工作，重点实现了基于绘制范围的模糊查询、可拖动的布局卷帘以及多类别 POI 的叠加显示功能。

## 1. 新增需求与任务

### 1.1 模糊查询 (Fuzzy Search)

**需求描述**：
在绘制工具旁添加搜索框，允许用户在已绘制的范围内，通过关键词（如“咖啡”）对 POI 进行二次筛选。

- **交互流程**：绘制范围 -> 点击运行 -> 输入关键词 -> 点击查询 -> 更新地图高亮和标签云。
- **反馈**：弹出提示框显示匹配数量。
- **清除功能**：新增“清除查询结果”按钮，点击后恢复为初始筛选的 POI 和内容，并将布局算法重置为“动态重心引力”。
- **布局优化**：将查询工具组（输入框、查询按钮、清除按钮）移动至顶部控制栏左侧，紧邻算法选择框。确保“清除查询结果”按钮的右边缘在初始状态下与地图布局的右边缘对齐（即屏幕中线位置）。

### 1.2 布局卷帘调整 (Layout Splitter)

**需求描述**：
实现地图与标签云布局宽度的自由调整。

- **交互**：拖动中间的分隔条调整左右比例。
- **视觉增强**：分隔条中央添加了双向箭头图标，提升可视性。
- **约束**：两侧最小宽度限制为 20%。
- **布局优化**：
  - 顶部控制栏不再随卷帘联动，保持初始对齐状态。
  - 修复了右侧标签云布局在调整时出现黑色背景的问题，通过 `flex: 1` 自动填充剩余空间，并确保 `TagCloud` 组件在调整大小时自动重绘。
  - 右侧控制栏背景色恢复为默认深灰色，避免视觉割裂。

### 1.3 POI 多类叠加 (Category Overlay)

**需求描述**：
支持同时显示多个类别的 POI，并用不同颜色区分。

- **模式切换**：新增“筛选叠加”开关（显示为“开启/关闭”）。
- **逻辑**：
  - 关闭：单选模式，切换类别即替换。
  - 开启：叠加模式，切换类别即追加（最多 3 类）。
- **视觉**：
  - 第一类：红色半透明圆圈
  - 第二类：蓝色半透明圆圈
  - 第三类：紫色半透明圆圈

### 1.4 移动端适配 (Mobile Adaptation)

**需求描述**：
针对手机端进行布局适配。

- **布局**：强制上下堆叠布局，隐藏分隔条。
- **宽度**：左右面板宽度强制为 100%。

---

## 2. 功能实现详解

### 2.1 模糊查询实现

**涉及文件**：`ControlPanel.vue`, `App.vue`

1.  **UI 调整**：

    - 在 `ControlPanel` 中将查询工具组从右侧控制区移动至左侧控制区。
    - 使用 `justify-content: space-between` 布局，确保左侧控制区（宽度固定为 50%）内的元素两端对齐，从而实现“清除查询结果”按钮右对齐到屏幕中线的效果。
    - 新增“清除查询结果”按钮，绑定 `handleClearSearch` 事件。

2.  **筛选逻辑**：
    - `App.vue` 维护 `selectedFeatures`（当前绘制范围内的所有 POI）和 `tagData`（当前显示的 POI）。
    - 当触发搜索时，基于 `selectedFeatures` 进行关键词过滤，更新 `tagData`。
    - 当点击清除时，将 `tagData` 重置为 `selectedFeatures`，并将 `selectedAlgorithm` 重置为 `'basic'`。
    - 调用 `MapContainer.showHighlights` 同步更新地图上的高亮显示。

### 2.2 布局卷帘实现

**涉及文件**：`App.vue`, `ControlPanel.vue`, `TagCloud.vue`

1.  **Splitter 组件**：

    - 在 `App.vue` 的左右面板之间插入 `<div class="splitter">`，并嵌入 SVG 双向箭头图标。
    - 监听全局 `mousemove` 和 `mouseup` 事件实现拖拽逻辑。
    - 计算 `splitPercentage`（百分比），并限制在 20% - 80% 之间。

2.  **响应式布局**：
    - 左侧面板宽度使用 `calc(${splitPercentage}% - 6px)` 动态计算。
    - 右侧面板使用 `flex: 1` 自动占据剩余空间，配合 `min-width: 0` 防止内容溢出。
    - **关键修复**：在 `TagCloud.vue` 中暴露 `resize` 方法，并在 `App.vue` 的 `handleResize` 中调用。确保当卷帘拖动改变容器大小时，标签云（SVG）能够感知尺寸变化并重新渲染，消除因 SVG 尺寸未更新而产生的黑色背景缝隙。

### 2.3 POI 叠加与动态样式

**涉及文件**：`MapContainer.vue`, `App.vue`

1.  **数据管理 (`App.vue`)**：

    - 引入 `activeGroups` 数组存储当前选中的分组。
    - 在 `handleDataLoaded` 中根据 `overlayEnabled` 状态决定是替换还是追加分组。
    - **索引标记**：在合并数据时，为每个 Feature 添加 `_groupIndex` 属性 (0, 1, 2)，用于后续样式映射。

2.  **动态样式 (`MapContainer.vue`)**：

    - 重构 `highlightLayer` 的 style 配置为函数形式。
    - 根据 `feature.get('__raw').properties._groupIndex` 动态返回不同颜色的样式：
      - 0 -> Red
      - 1 -> Blue
      - 2 -> Purple

3.  **选区持久化**：
    - 在 `MapContainer` 中缓存当前的绘制几何体 (`currentGeometry`)。
    - 当 POI 数据更新（如切换类别）时，自动重新执行“点在多边形内”的判断逻辑，确保新加载的类别能立即在现有绘制范围内显示，无需用户重新绘制。

---

## 3. 遇到的挑战与解决方案

### 3.1 顶部控制栏对齐问题

- **问题**：顶部控制栏是全宽的，而下方是左右分割的。简单的 Flex 布局无法保证顶部搜索框精确对齐到下方的分割线。
- **解决**：将 `splitPercentage` 状态提升至 `App.vue`，并作为 Prop 传给 `ControlPanel`。`ControlPanel` 内部显式设置左右两个子容器的宽度百分比，从而实现上下布局的严格对齐。

### 3.2 叠加模式下的数据筛选

- **问题**：用户先绘制了范围，然后切换类别。默认情况下，新类别加载后，之前的筛选结果（绘制范围内的点）会丢失，或者新类别显示了全部点（未经过筛选）。
- **解决**：在 `MapContainer` 中实现“选区持久化”。记录最后一次绘制的几何图形。当 `poiFeatures` 属性变化时，自动触发 `refreshSelection` 逻辑，用缓存的几何图形对新数据进行再次筛选。

### 3.3 布局溢出导致的黑色背景

- **问题**：在使用百分比宽度布局时，未考虑到分隔条的固定宽度，导致总宽度超过 100%，右侧面板被挤压或产生溢出，暴露出底层的黑色背景。此外，`TagCloud` 组件内的 SVG 不会自动跟随容器大小变化。
- **解决**：
  1.  左侧面板保留 `calc` 计算宽度，右侧面板改为 `flex: 1`，确保布局严丝合缝。
  2.  在 `TagCloud.vue` 中实现并暴露 `resize` 方法，在 `App.vue` 拖动卷帘时主动调用该方法，触发 SVG 重绘，确保内容始终填满容器。

---

## 4. 总结

本次更新显著增强了应用的交互灵活性和数据分析能力。模糊查询提供了细粒度的检索手段，布局调整适应了不同屏幕和用户习惯，而 POI 叠加功能则开启了多维度地理数据对比分析的可能性。

---

## 5. 解决不同浏览器布局下控件重叠的 BUG

**时间**：2025-12-11

### 5.1 问题描述

在不同浏览器（或不同的屏幕分辨率）下，webapp 顶部菜单栏的控件出现重叠、错位的情况。主要表现为：

1.  **菜单栏重叠**：上方菜单栏控件会出现相互遮挡。
2.  **对齐无效**：地图控制栏（左侧）和标签云工具栏（右侧）无法固定在各自的视图上方。
3.  **布局错乱**：在调整浏览器窗口大小或改变卷帘位置时，工具栏位置不稳定。
4.  **移动端布局失效**：在移动端设备上，原有的适配方案失效，导致无法正常操作。

### 5.2 解决方案

针对上述问题，进行了全面的布局重构，核心思路是将原本浮动的、依赖 JavaScript 计算宽度的布局，改为基于 CSS Flexbox 的响应式分栏布局。

#### 5.2.1 桌面端布局重构

1.  **拆分顶部 Header**：

    - 废弃了原有的全局单栏 Header。
    - 引入新的 `.fixed-top-header`，内部包含两个固定宽度为 `50%` 的容器：`.header-left` 和 `.header-right`。
    - **`.header-left`**：放置地图相关的控件（分组选择、算法选择、搜索框），强制左对齐 (`justify-content: flex-start`)。
    - **`.header-right`**：放置标签云相关的工具（绘制、运行、初始化），强制右对齐 (`justify-content: flex-end`)。
    - 无论下方卷帘（Splitter）如何拖动，上方的工具栏始终保持 `50:50` 的固定比例，彻底解决了控件跟随卷帘移动导致的错位问题。

2.  **组件复用与解耦**：

    - 重构 `ControlPanel.vue`，新增 `panelType` 属性。
    - 根据传入的 `panelType` (`'map'` 或 `'tag'`)，组件智能决定渲染左侧控件还是右侧控件。
    - 引入 `localAlgorithm` 配合 `watch` 和 `emit`，实现了两个独立 ControlPanel 实例之间的算法选择状态同步。

3.  **默认参数调整**：
    - 将默认算法从 `'spiral'`（阿基米德螺线）更改为 `'basic'`（动态重心引力），优化初始体验。

#### 5.2.2 移动端适配修复

1.  **独立移动端 Header**：

    - 为移动端引入了专属的 `<header class="mobile-header">`。
    - 实例化一个独立的 `ControlPanel` (类型为 `'mobile'`)，专门负责移动端的交互逻辑。
    - 绑定了所有必要的事件监听器（搜索、绘制、运行等），确保功能完备。

2.  **响应式切换逻辑**：

    - 利用 CSS 媒体查询 (`@media (max-width: 768px)`) 严格控制显示逻辑：
      - **桌面端 (>768px)**：显示左右分栏的 50/50 布局，隐藏移动端 Header。
      - **移动端 (≤768px)**：隐藏桌面端分栏，仅显示统一的移动端 Header。

### 5.3 修复效果

- **布局稳固**：无论在何种浏览器或屏幕尺寸下，顶部工具栏均保持左右 50/50 分布，不再重叠。
- **对齐精准**：左侧控件组始终左对齐，右侧控件组始终右对齐，视觉整洁。
- **移动端可用**：移动端恢复了简洁的顶部菜单 + 更多操作下拉菜单的设计，功能完全正常。
