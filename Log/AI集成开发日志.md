# AI 对话功能集成指南

## 📋 功能概述

本系统已成功集成本地大模型（Qwen3-4B-Instruct），支持基于 POI 数据的智能分析对话。

## 🏗️ 新增文件

| 文件                        | 说明                                 |
| --------------------------- | ------------------------------------ |
| `src/utils/aiService.js`    | AI 服务模块，封装与 LM Studio 的通信 |
| `src/components/AiChat.vue` | AI 对话组件，美观的聊天界面          |
| `vite.config.js`            | 添加了 API 代理配置                  |

## 🔧 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                    三栏布局界面                               │
│  ┌─────────────┬─────────────────┬───────────────────┐      │
│  │   地图容器   │     标签云容器    │    AI 对话面板    │      │
│  │ MapContainer│    TagCloud     │      AiChat       │      │
│  │    35%      │      35%        │       30%         │      │
│  └─────────────┴─────────────────┴───────────────────┘      │
│       ↑ 卷帘1 ↑                     ↑ 卷帘2 ↑                │
├─────────────────────────────────────────────────────────────┤
│                    数据流                                     │
│  用户绘制区域 → 筛选 POI → selectedFeatures → AiChat 组件      │
│                                     ↓                        │
│                           注入 AI 系统提示词                   │
│                                     ↓                        │
│                        Vite Proxy → LM Studio API            │
└─────────────────────────────────────────────────────────────┘
```

## ⚙️ 配置说明

### Vite 代理配置 (vite.config.js)

```javascript
server: {
  proxy: {
    '/api/ai': {
      target: 'http://localhost:1234',  // LM Studio 服务地址
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api\/ai/, '/v1'),
      timeout: 120000,  // 2分钟超时
    }
  }
}
```

### API 路由映射

| 前端请求                   | 代理后请求                                  |
| -------------------------- | ------------------------------------------- |
| `/api/ai/models`           | `http://localhost:1234/v1/models`           |
| `/api/ai/chat/completions` | `http://localhost:1234/v1/chat/completions` |

## 🚀 使用步骤

### 1. 启动 LM Studio

确保 LM Studio 运行并加载了 Qwen3-4B-Instruct 模型：

- 打开 LM Studio
- 加载模型：`qwen3-4b-instruct-2507`
- 启动本地服务器（默认端口 1234）

### 2. 启动 Web 应用

```bash
cd d:\AAA_Edu\TagCloud\vite-project
npm run dev
```

### 3. 使用 AI 分析功能

1. **选择 POI 数据**：使用左侧地图的绘制工具（多边形/圆形）框选 POI
2. **查看 AI 上下文**：右侧 AI 面板会自动接收选中的 POI 数据
3. **开始对话**：在输入框中提问或点击快捷操作按钮

## 🎨 界面特性

### AI 对话面板

- **状态指示**：实时显示 AI 服务在线/离线状态
- **POI 徽章**：显示当前已加载的 POI 数量
- **流式响应**：逐字显示 AI 回复，提升用户体验
- **Markdown 渲染**：支持代码块、列表、粗体等格式
- **快捷操作**：预设常用分析问题
- **深色主题**：与整体界面风格统一

### 卷帘调整

- **第一个卷帘**（蓝色）：调整地图与标签云的宽度比例
- **第二个卷帘**（紫色）：调整标签云与 AI 面板的宽度比例
- **约束范围**：每个面板最小 15%，最大 90%

## 📝 AI 提示词策略

系统会自动将选中的 POI 数据格式化为上下文，注入到 AI 的系统提示中：

```
当前数据上下文:
📍 **当前选中区域 POI 统计**
- 总数量: 150 个
- 类别分布:
  · 餐饮美食: 45 个 (30.0%)
  · 购物消费: 38 个 (25.3%)
  ...

**部分 POI 示例** (共 20 个):
1. 星巴克咖啡 [餐饮美食] - 武汉市江汉区...
2. 沃尔玛超市 [购物消费] - ...
...
```

## 🔍 调试技巧

1. **检查 AI 服务连接**：观察面板右上角的状态指示器
2. **查看控制台日志**：`[AiChat]` 前缀的日志显示对话相关信息
3. **验证代理**：浏览器开发者工具 Network 面板查看 `/api/ai/*` 请求

## ⚠️ 注意事项

1. **必须先启动 LM Studio**：否则 AI 面板显示"离线"状态
2. **首次对话较慢**：JIT 模型加载可能需要几秒钟
3. **重启开发服务器**：修改 `vite.config.js` 后需要重启
