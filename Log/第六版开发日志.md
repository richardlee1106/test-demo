# 开发日志：标签权重渲染与颜色分类功能

本文档记录了标签云权重渲染功能的开发过程，包括栅格数据集成、Jenks 分类着色、UI 控件设计以及 Bug 修复。

**开发日期**：2025-12-16

---

## 1. 新增需求汇总

在原有标签云 WebGIS 应用的基础上，主要增加了以下功能需求：

1.  **栅格权重集成 (Raster Weight Integration)**：

    - 使用人口密度 GeoTIFF 栅格数据为 POI 赋予权重值。
    - 高权重的 POI 标签在布局时优先放置在靠近中心的位置。
    - 标签字体大小根据权重动态调整。

2.  **标签颜色分类渲染 (Jenks Natural Breaks)**：

    - 根据权重值对标签进行 5 级分类着色。
    - 使用暖色系配色方案（蓝 → 白 → 红）。
    - 提供美观的颜色图例显示。

3.  **权重控制 UI (Weight Control UI)**：

    - 在地图控制面板中添加"标签权重"滑块，开启时弹出权重类型选择弹窗。
    - 添加"显示权重"滑块，在标签文本后显示权重数值。
    - 两个滑块存在依赖关系："显示权重"依赖于"标签权重"开启。

4.  **悬停高亮 Bug 修复 (Hover Highlight Fix)**：
    - 解决标签悬停时高亮错误标签的问题。
    - 使用坐标唯一键替代原有的索引匹配方式。

---

## 2. 功能实现详解

### 2.1 栅格权重集成

**技术栈**：geotiff.js, Web Worker

**核心文件**：`src/utils/RasterExtractor.js`

**实现逻辑**：

1.  **栅格加载**：

    - 使用 `geotiff.js` 库解析 GeoTIFF 文件 (`武汉POP.tif`)。
    - 一次性将栅格数据读入内存，支持快速像元值查询。
    - 自动获取栅格边界框 (bbox)、尺寸、NoData 值等元数据。

    ```javascript
    // RasterExtractor.js - 核心加载逻辑
    async load(url) {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      this.tiff = await GeoTIFF.fromArrayBuffer(arrayBuffer);
      this.image = await this.tiff.getImage();
      this.rasterData = (await this.image.readRasters())[0];
      this.bbox = this.image.getBoundingBox();
    }
    ```

2.  **值提取**：

    - 根据经纬度坐标计算对应的栅格行列号。
    - 处理 NoData 值和边界检查，返回有效像元值或 0。

    ```javascript
    // 坐标转像素索引
    const col = Math.floor((lon - minX) / pixelWidth);
    const row = Math.floor((maxY - lat) / pixelHeight);
    const index = row * this.width + col;
    return this.rasterData[index];
    ```

3.  **Worker 排序优化**：
    - 在 `basic.worker.js`、`spiral.worker.js`、`geo.worker.js` 中修改排序逻辑。
    - 当存在权重数据时，按权重降序排序，确保高权重标签优先放置。
    - 字体大小基于权重动态归一化：`fontSize = 12 + 16 * (weight / maxWeight)`。

### 2.2 Jenks 自然断点分类

**技术栈**：自定义算法（分位数近似）

**核心文件**：`src/components/TagCloud.vue`

**实现逻辑**：

1.  **分类算法**：

    - 实现简化版 Jenks 算法，使用分位数作为断点近似。
    - 将权重数据划分为 5 个等级。

    ```javascript
    function jenksBreaks(data, numClasses) {
      const sortedData = data.filter((d) => d > 0).sort((a, b) => a - b);
      const breaks = [];
      for (let i = 1; i < numClasses; i++) {
        const idx = Math.floor((i * n) / numClasses);
        breaks.push(sortedData[idx]);
      }
      breaks.push(sortedData[n - 1]); // 最大值
      return breaks;
    }
    ```

2.  **暖色系配色**：

    - 定义 5 级颜色数组，从蓝色到红色渐变：

    ```javascript
    const WEIGHT_COLORS = [
      "#2166ac", // 蓝色 (最低)
      "#67a9cf", // 浅蓝
      "#f7f7f7", // 白色 (中间)
      "#ef8a62", // 浅红
      "#b2182b", // 深红 (最高)
    ];
    ```

3.  **颜色映射**：

    - 根据权重值查找对应的分类颜色。
    - 在标签渲染和高亮更新时统一使用 `getWeightColor()` 函数。

4.  **图例生成**：
    - 自动计算每个分类的数值范围。
    - 在标签云左下角显示颜色-数值对应关系。

### 2.3 权重控制 UI

**技术栈**：Vue 3, Element Plus

**核心文件**：`src/components/MapContainer.vue`, `src/App.vue`

**实现逻辑**：

1.  **滑块控件**：

    - 在"筛选叠加"下方添加分隔线和两个滑块。
    - "标签权重"滑块：开启时弹出权重类型选择弹窗。
    - "显示权重"滑块：依赖于"标签权重"开启状态。

    ```html
    <!-- 标签权重控件 -->
    <div class="control-row">
      <span class="filter-label">标签权重</span>
      <el-switch v-model="weightEnabled" @change="handleWeightToggle" />
    </div>
    <div class="control-row">
      <span class="filter-label" :class="{ 'disabled': !weightEnabled }"
        >显示权重</span
      >
      <el-switch v-model="showWeightValue" :disabled="!weightEnabled" />
    </div>
    ```

2.  **权重选择弹窗**：

    - 使用 `el-dialog` 组件，标题为"请选择需要渲染的地理权重"。
    - 取消按钮关闭弹窗并恢复滑块状态。
    - 确定按钮触发栅格加载和标签云重新渲染。

3.  **事件流**：
    - `MapContainer` → `weight-change` 事件 → `App.vue` 处理 → 调用 `TagCloud.loadRaster()` → 更新 `weightEnabled`/`showWeightValue` props。

### 2.4 悬停高亮 Bug 修复

**技术栈**：D3.js, Vue 3

**核心文件**：`src/components/TagCloud.vue`

**问题根因**：

- 原实现使用 `originalIndex` 进行标签与原始数据的匹配。
- 当数据经过排序或过滤后，索引对应关系被打乱，导致悬停时高亮错误的标签。

**解决方案**：

1.  **坐标唯一键**：

    - 为每个标签生成基于经纬度的唯一标识符 `coordKey`。

    ```javascript
    function makeCoordKey(lon, lat) {
      return `${lon?.toFixed(6)}_${lat?.toFixed(6)}`;
    }
    ```

2.  **映射表构建**：

    - 在 `runLayout` 时构建 `featureMap`（`Map<coordKey, Feature>`）。
    - 将坐标键映射回原始 GeoJSON Feature 对象。

3.  **事件处理优化**：
    - `mouseover`、`mouseout`、`click` 事件通过 `coordKey` 从映射表查找匹配的 Feature。
    - `updateHighlight` 函数也使用 `coordKey` 进行精确匹配。

---

## 3. 变更修改

### 新增文件

| 文件路径                       | 功能描述                                          |
| ------------------------------ | ------------------------------------------------- |
| `src/utils/RasterExtractor.js` | 栅格数据提取工具类，实现 GeoTIFF 加载和像元值查询 |

### 修改文件

| 文件路径                          | 修改内容                                                  |
| --------------------------------- | --------------------------------------------------------- |
| `src/components/TagCloud.vue`     | 添加权重 props、Jenks 分类、颜色映射、图例、coordKey 匹配 |
| `src/components/MapContainer.vue` | 添加权重控件滑块、弹窗、事件处理                          |
| `src/App.vue`                     | 添加权重状态管理、事件处理、props 传递                    |
| `src/workers/basic.worker.js`     | 修改字体大小归一化、按权重排序                            |
| `src/workers/spiral.worker.js`    | 修改字体大小归一化、按权重排序                            |
| `src/workers/geo.worker.js`       | 添加权重排序逻辑（优先于地理距离）                        |

---

## 4. 遇到的问题与解决办法

### 问题 1：`cullingViewport is not defined`

- **现象**：控制台报 ReferenceError，标签云缩放/拖拽时报错。
- **原因**：视口裁剪函数 `cullingViewport` 在某次重构中被移除，但调用代码未同步删除。
- **解决**：注释掉 Zoom 回调中的 `cullingViewport(width, height)` 调用。

### 问题 2：标签云操作后颜色变回默认

- **现象**：启用权重后标签正确着色，但缩放/拖拽后颜色恢复为默认蓝色。
- **原因**：`updateHighlight` 函数未使用权重颜色逻辑，在悬停状态变化时将所有非高亮标签重置为 `#bfeaf1`。
- **解决**：修改 `updateHighlight`，在权重启用时调用 `getWeightColor(d.weight)` 获取正确颜色。

### 问题 3：显示权重值后标签重叠

- **现象**：开启"显示权重"后，标签文本追加权重数字，但布局未重新计算导致重叠。
- **原因**：Worker 测量的是原始文本宽度，未考虑追加的权重后缀。
- **解决**：在数据预处理阶段将权重值附加到 `displayName`，使 Worker 正确测量完整文本宽度。

  ```javascript
  let displayName = name;
  if (props.showWeightValue && weight > 0) {
    displayName = `${name} (${Math.round(weight)})`;
  }
  ```

### 问题 4：悬停高亮不精确

- **现象**：鼠标悬停在标签 A 上时，高亮的是标签 B。
- **原因**：排序后 `originalIndex` 不再指向正确的 Feature。
- **解决**：使用 `coordKey`（经纬度唯一键）建立精确映射，替代索引匹配。

---

## 5. 最终功能总结

### 已实现功能

| 功能           | 状态 | 说明                                   |
| -------------- | ---- | -------------------------------------- |
| 栅格权重提取   | ✅   | 从 GeoTIFF 读取人口密度值作为 POI 权重 |
| 权重排序布局   | ✅   | 高权重标签优先放置在中心位置           |
| Jenks 颜色分类 | ✅   | 5 级暖色系分类着色                     |
| 颜色图例       | ✅   | 左下角显示颜色-数值对应关系            |
| 显示权重值     | ✅   | 标签文本后追加权重数字                 |
| 权重控制 UI    | ✅   | 滑块 + 弹窗交互                        |
| 悬停高亮修复   | ✅   | 使用坐标键精确匹配                     |

### 已移除功能

| 功能       | 原因           |
| ---------- | -------------- |
| 栅格热力图 | 用户反馈不需要 |

---

## 6. 技术亮点

1.  **单例栅格提取器**：避免重复加载大型栅格文件，提升性能。
2.  **动态权重归一化**：根据当前数据集的最大权重进行归一化，适应不同数据范围。
3.  **坐标键映射**：解决了数据排序/过滤后的精确匹配问题，保证交互正确性。
4.  **预处理显示名称**：将权重后缀在 Worker 前处理，确保布局正确。
5.  **依赖关系设计**：UI 滑块的依赖关系提供清晰的用户体验。

---

## 7. 性能考虑

- **栅格数据缓存**：一次加载后常驻内存，后续提取只需查表。
- **Worker 布局**：复杂布局计算在 Web Worker 中执行，不阻塞 UI。
- **节流与防抖**：事件处理使用适当的节流策略减少计算频率。
- **增量更新**：D3 的 data join 机制只更新变化的元素。
