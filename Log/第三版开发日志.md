# 开发日志（第三版）：深度优化与地理空间布局

**时间**：2025-12-06
**主题**：代码汉化、标签云布局算法重构、中心型地理布局实现

本文档记录了在完成第二版功能开发后，针对用户反馈的“密集区域重叠”、“间隙过大”问题进行的深度优化，以及根据新需求实现的“中心型地理空间布局”功能。

## 1. 新增需求与任务

### 1.1 标签云布局深度优化 (Layout Optimization)
1.  **解决重叠**：针对 POI 密集区域（如商圈）标签重叠率高达 1/3 的问题进行专项修复。
2.  **紧凑化**：在消除重叠的同时，减少标签之间的无效间隙，使布局更紧凑。
3.  **算法重构**：优化碰撞检测算法，从简单的力导向升级为多阶段物理模拟。

### 1.2 代码全量汉化 (Localization)
1.  将项目中所有的控制台日志 (`console.log/warn`) 从英文翻译为中文。
2.  将核心算法文件的代码注释翻译为中文，并补充详细的逻辑说明。

### 1.3 中心型地理空间布局 (Geo-Spatial Layout)
**新需求描述**：
在“绘制圆形”模式下，标签云的布局需要发生根本性变化，以解决传统词云丢失空间信息的问题。
1.  **中心锚点**：以绘制圆形的圆心为中心，在标签云正中央显示“中心位置”文本。
    *   样式：橙黄色高亮，字号放大，区别于其他 POI。
    *   位置：固定在画布中心。
2.  **严格地理方位**：
    *   标签云中文字的相对位置，必须与地图上真实店铺的地理方位保持严格一致。
    *   遵循“上北下南、左西右东”原则。
    *   例如：如果店铺 A 在圆心的西北方向，那么在标签云中，店铺 A 的文字也必须位于“中心位置”的西北方向。
3.  **视觉保持**：在保持地理相对位置的同时，尽可能紧凑且不重叠。

---

## 2. 功能实现详解

### 2.1 标签云布局算法重构 (GeoWorker)
**文件**：`src/workers/geo.worker.js`

#### A. 自定义矩形碰撞检测 (Custom AABB Collision)
*   **原方案**：使用 D3 内置的 `forceCollide`（圆形检测）。缺点是长方形文字标签会被视为大圆，导致标签间隙极大。
*   **新方案**：手写 `rectCollide` 函数，基于 **轴对齐包围盒 (AABB)** 原理。
*   **逻辑**：
    *   计算两个矩形的重叠量 (`overlapX`, `overlapY`)。
    *   若发生重叠，选择重叠量较小的轴向（最小分离轴）进行推移。
    *   **Padding 优化**：将碰撞间隙 (`padding`) 设为 **1px**，实现像素级紧凑。

#### B. 多阶段模拟机制 (Multi-Phase Simulation)
为了解决密集区域的顽固重叠，采用了分阶段模拟策略：
1.  **阶段一：动态模拟 (Dynamic Simulation, 300帧)**
    *   启用微弱的“引力” (`strength: 0.05`) 将标签拉向其地理目标位置。
    *   同时启用强力的“碰撞斥力”，允许标签为了避让拥挤而大幅度“漂移”。
2.  **阶段二：静态清理 (Static Cleanup, 120帧)**
    *   **完全关闭引力**，仅运行碰撞检测。
    *   模拟“退火”过程，强制将残余的重叠标签推开，彻底根治重叠问题。

### 2.2 中心型地理布局实现
**文件**：`src/workers/geo.worker.js`

#### A. 中心标签注入
在 Worker 接收到数据后，手动创建一个虚拟的 Center Tag：
```javascript
const centerTag = {
    name: '中心位置',
    isCenter: true,
    x: width / 2, y: height / 2, // 初始位置
    fx: width / 2, fy: height / 2, // D3 固定位置 (Fixed)
    fontSize: fontMax + 4,
    color: '#FFA500' // 逻辑上标记为高亮
};
allNodes = [centerTag, ...processedTags];
```

#### B. 地理投影与相对位置计算
为了在 2D 画布上还原真实的地理方位，采用了以下投影逻辑：
1.  **中心点确定**：使用用户绘制圆形的圆心经纬度 (`centerLon`, `centerLat`) 作为坐标原点。
2.  **高纬度修正**：
    *   由于地球是球体，高纬度地区经度线收缩。直接使用 `dLon` 会导致横向拉伸。
    *   引入修正因子：`factorX = Math.cos(centerLat * PI / 180)`。
3.  **目标位置计算**：
    ```javascript
    // 计算相对于中心的物理偏移
    const dx = (tag.lon - centerLon) * factorX;
    const dy = (tag.lat - centerLat) * 1;
    
    // 映射到画布坐标 (Y轴翻转：屏幕向下为正，纬度向上为正)
    targetX = width / 2 + dx * scale;
    targetY = height / 2 - dy * scale;
    ```
4.  **D3 力场约束**：
    *   将计算出的 `targetX/Y` 设置为 D3 `forceX/Y` 的目标。
    *   标签会尽力靠近其地理真实位置，但在碰撞时会被挤开，从而在“地理真实性”和“可视性”之间取得平衡。

### 2.3 系统健壮性修复
1.  **Worker 数据通信 (DataCloneError)**：
    *   Vue 3 的 Proxy 对象无法直接传给 Worker。
    *   修复：`JSON.parse(JSON.stringify(tags))` 深拷贝去壳。
2.  **重复函数声明**：
    *   修复 `App.vue` 中重复的 `handleRunAlgorithm`，解决构建警告。

---

## 3. 遇到的问题与解决办法

### 问题 1：Worker 报错 DataCloneError
*   **现象**：`Uncaught DOMException: Failed to execute 'postMessage' on 'Worker': [object Array] could not be cloned.`
*   **原因**：Vue 3 的响应式数据 (`ref` 或 `reactive`) 是通过 Proxy 实现的。当直接将这些 Proxy 对象作为参数传递给 `worker.postMessage` 时，浏览器尝试使用结构化克隆算法 (Structured Clone Algorithm) 进行拷贝，但 Proxy 对象通常包含不可枚举或内部的 handler 属性，导致克隆失败。
*   **解决**：在传递数据前，使用 `JSON.parse(JSON.stringify(tags))` 对数据进行一次深拷贝，剥离 Vue 的 Proxy 包装，仅保留纯净的 JSON 数据。

### 问题 2：App.vue 重复函数声明
*   **现象**：Vue 编译警告或运行时逻辑异常，提示 `handleRunAlgorithm` 标识符重复。
*   **原因**：在代码重构或合并过程中，不小心保留了旧的函数定义，导致同一作用域下存在两个同名函数。
*   **解决**：删除冗余的函数定义，确保逻辑收敛到唯一的 `handleRunAlgorithm` 方法中。

### 问题 3：传统词云丢失空间信息
*   **背景**：传统词云通常只根据权重大小随机或螺旋排列，用户无法感知店铺的实际方位。
*   **解决**：
    *   创新性地引入“中心锚点”+“相对坐标投影”。
    *   强制标签向其真实的地理相对位置靠拢。
    *   结果：用户一眼就能看出“某个店在中心的西北角”，实现了地图与词云的空间认知统一。

### 问题 4：高纬度地区布局变形
*   **现象**：在纬度较高（如北京 40°N）的区域，标签云看起来比实际地图“扁”或“宽”。
*   **原因**：简单的经纬度差值映射未考虑地球曲率。在墨卡托投影或地理坐标系中，相同的经度差在不同纬度代表的实际距离是不同的。
*   **解决**：引入校正因子 `factorX = Math.cos(centerLat)`，对经度差值进行加权，恢复真实的视觉比例。

### 问题 5：密集区域重叠率高 (1/3)
*   **现象**：在商圈等 POI 密集处，标签大量堆叠，无法辨认。
*   **原因**：单阶段模拟中，引力（拉向原位）与斥力（避让）过早达到平衡，形成了局部极小值。且 D3 默认的 `forceCollide` 是基于圆形的，对于长方形文本包裹性差，导致为了不重叠必须留出很大间隙，或者为了紧凑而不得不重叠。
*   **解决**：
    *   **自定义矩形碰撞**：放弃圆形碰撞，手写 AABB 矩形碰撞检测，实现像素级贴合。
    *   **多阶段策略**：先“动”后“静”。先用弱引力让大致归位，再关掉引力用纯斥力清理重叠。
