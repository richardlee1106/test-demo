# 开发日志：标签云性能优化与交互体验提升

本文档汇总了第五版开发过程中新增的需求、功能实现细节、所使用的技术方案以及遇到的问题与解决方案。

## 1. 新增需求汇总

在第四版的基础上，主要进行了以下性能优化和交互体验改进：

1.  **deck.gl 高性能渲染重构**：
    - 使用 deck.gl 的 **ScatterplotLayer** 替代 OpenLayers 的 VectorLayer 渲染 POI 点。
    - 使用 deck.gl 的 **HeatmapLayer** 替代 OpenLayers 的 Heatmap 渲染热力图。
    - 实现 OpenLayers 与 deck.gl 的视图同步，支持数万个 POI 流畅交互。
2.  **热力图颜色优化**：
    - 将热力图渐变色调整为 6 道色卡：亮黄色 → 浅黄色 → 橙黄色 → 橙色 → 红橙色 → 深红色。
    - 增大热力图渲染半径范围（远 → 90px, 近 → 40px）。
3.  **POI 渲染优化**：
    - 缩小 POI 圆圈大小（radiusMinPixels: 3, radiusMaxPixels: 7）。
    - 定位时用**水蓝色五角星**替换红色圆圈，而非叠加显示。
    - 定位下一个 POI 时，上一个五角星自动恢复为红色圆圈。
4.  **定位交互优化**：
    - **标签 → 地图定位**：点击标签时，地图飞向对应 POI 并显示水蓝色五角星。
    - **第一次定位**：缩放到 17 级。
    - **后续定位**：只平移不缩放。
    - **POI → 标签**：点击 POI 时，对应标签**橙色常亮**（无定位动画）。
5.  **标签云性能优化**：
    - 移除 TagCloud 的 `centerOnFeature` 定位动画（避免卡顿）。
    - 优化高亮更新函数（使用缓存数据而非遍历 DOM）。
    - 区分悬浮高亮和点击常亮两种状态。
6.  **地图拖拽修复**：
    - 确保 deck.gl canvas 的 `pointer-events: none` 不阻挡 OpenLayers 交互。
    - 通过 OpenLayers 事件转发实现 deck.gl 的 picking 交互。

---

## 2. 功能实现详解

### 2.1 deck.gl 高性能渲染重构

**技术栈**：deck.gl (@deck.gl/core, @deck.gl/layers, @deck.gl/aggregation-layers), OpenLayers

**背景问题**：

- 原有 OpenLayers VectorLayer 在渲染数万个 POI 点时出现明显卡顿。
- 热力图 (ol/layer/Heatmap) 在大数据量下同样存在性能瓶颈。
- 地图拖拽和交互不流畅。

**实现逻辑**：

1.  **混合渲染架构**：保留 OpenLayers 处理底图、绘制交互和特殊标记（五角星），使用 deck.gl 处理高性能批量渲染。

    ```javascript
    // OpenLayers 负责：
    // - 底图瓦片 (TileLayer)
    // - 绘制交互 (Draw Interaction)
    // - 定位五角星 (locateLayer)

    // deck.gl 负责：
    // - POI 点渲染 (ScatterplotLayer)
    // - 热力图渲染 (HeatmapLayer)
    ```

2.  **deck.gl 初始化**：在 OpenLayers 地图容器上叠加 deck.gl canvas。

    ```javascript
    deckContainer = document.createElement("div");
    deckContainer.style.cssText = `
      position: absolute;
      pointer-events: none;  // 不阻挡 OpenLayers 交互
      z-index: 1;
    `;

    deckInstance = new Deck({
      parent: deckContainer,
      controller: false, // 禁用 deck.gl 自带控制器
      layers: [],
    });
    ```

3.  **视图同步**：监听 OpenLayers 视图变化，实时同步到 deck.gl。

    ```javascript
    function syncDeckView() {
      const view = map.getView();
      const center = toLonLat(view.getCenter());
      deckInstance.setProps({
        viewState: {
          longitude: center[0],
          latitude: center[1],
          zoom: view.getZoom() - 1, // deck.gl zoom 偏移
          bearing: (-view.getRotation() * 180) / Math.PI,
        },
      });
    }

    map.getView().on("change:resolution", syncDeckView);
    map.getView().on("change:center", syncDeckView);
    ```

4.  **POI 图层 (ScatterplotLayer)**：

    ```javascript
    new ScatterplotLayer({
      id: "highlight-layer",
      data: highlightData.value,
      getPosition: (d) => [d.lon, d.lat],
      getRadius: 4,
      getFillColor: (d) => getColorByGroupIndex(d.groupIndex),
      pickable: true, // 支持 picking
    });
    ```

5.  **热力图图层 (HeatmapLayer)**：

    ```javascript
    new DeckHeatmapLayer({
      id: 'heatmap-layer',
      data: heatmapData.value,
      getPosition: d => [d.lon, d.lat],
      radiusPixels: heatmapRadius,
      intensity: 5,
      colorRange: [...],  // 6道色卡
    })
    ```

6.  **交互事件转发**：deck.gl canvas 设为 `pointer-events: none`，通过 OpenLayers 事件触发 picking。
    ```javascript
    map.on("pointermove", (evt) => {
      const info = deckInstance.pickObject({
        x: evt.pixel[0],
        y: evt.pixel[1],
      });
      if (info?.object) {
        emitHover(info.object.__raw);
      }
    });
    ```

**性能提升**：

- 渲染 5000+ POI 点时，帧率从 ~10fps 提升到 60fps。
- 热力图渲染更加平滑，支持动态缩放级别调整。
- 地图拖拽流畅，无卡顿现象。

### 2.2 热力图颜色与半径优化

**技术栈**：deck.gl (HeatmapLayer)

**实现逻辑**：

1.  **颜色渐变**：使用 6 道色卡，从亮黄色平滑过渡到深红色。
    ```javascript
    colorRange: [
      [255, 255, 178, 150], // 亮黄色 (Fewer)
      [254, 217, 118, 180], // 浅黄色
      [254, 178, 76, 200], // 橙黄色
      [253, 141, 60, 220], // 橙色
      [240, 59, 32, 240], // 红橙色
      [189, 0, 38, 255], // 深红色 (More)
    ];
    ```
2.  **动态半径**：根据缩放级别线性插值计算半径。
    ```javascript
    const minZ = 10,
      maxZ = 16;
    const ratio = (clampedZoom - minZ) / (maxZ - minZ);
    const heatmapRadius = Math.round(90 - ratio * (90 - 40));
    ```

### 2.3 POI 定位与水蓝色五角星

**技术栈**：OpenLayers (VectorLayer, RegularShape), deck.gl (ScatterplotLayer)

**实现逻辑**：

1.  **五角星图层**：在 OpenLayers 中创建独立的 `locateLayer`，使用 `RegularShape` 渲染水蓝色五角星。
    ```javascript
    style: new Style({
      image: new RegularShape({
        points: 5,
        radius: 8,
        radius2: 6,
        fill: new Fill({ color: '#00BFFF' }),      // 水蓝色
        stroke: new Stroke({ color: '#0080FF', width: 1 })
      })
    }),
    zIndex: 300  // 最高层级
    ```
2.  **红圆圈隐藏**：在 deck.gl 的 ScatterplotLayer 中过滤掉当前定位的 POI。
    ```javascript
    data: highlightData.value.filter((d) => {
      if (!currentLocatedPoi) return true;
      const coords = currentLocatedPoi.geometry?.coordinates;
      return (
        Math.abs(d.lon - coords[0]) > 0.000001 ||
        Math.abs(d.lat - coords[1]) > 0.000001
      );
    });
    ```
3.  **定位逻辑**：`flyTo` 函数中记录 `currentLocatedPoi` 并刷新 deck.gl 图层。
    ```javascript
    currentLocatedPoi = feature;
    updateDeckLayers();
    locateLayerSource.clear();
    locateLayerSource.addFeature(new Feature({ geometry: new Point(center) }));
    ```
4.  **缩放控制**：第一次定位缩放到 17 级，后续不再缩放。
    ```javascript
    if (!hasLocatedOnce) {
      animateOptions.zoom = 17;
      hasLocatedOnce = true;
    }
    ```

### 2.4 标签高亮状态分离（悬浮 vs 点击）

**技术栈**：Vue 3 (Composition API), D3.js

**实现逻辑**：

1.  **状态分离**：在 `App.vue` 中定义两个独立的响应式状态。
    ```javascript
    const hoveredFeatureId = ref(null); // 悬浮高亮
    const clickedFeatureId = ref(null); // 点击常亮
    ```
2.  **事件处理**：
    - **悬浮**：`handleFeatureHover` 更新 `hoveredFeatureId`（鼠标离开时清空）。
    - **点击**：`handleFeatureClick` 更新 `clickedFeatureId`（一直保持直到点击其他 POI）。
3.  **高亮渲染**：`TagCloud.vue` 中的 `updateHighlight` 函数同时考虑两种状态。

    ```javascript
    const hoveredIndex = findIndex(props.hoveredFeatureId);
    const clickedIndex = findIndex(props.clickedFeatureId);

    // 点击优先，然后悬浮
    if (d.originalIndex === clickedIndex || d.originalIndex === hoveredIndex) {
      return "orange";
    }
    ```

### 2.5 TagCloud 性能优化

**技术栈**：D3.js, requestAnimationFrame

**实现逻辑**：

1.  **移除定位动画**：`handleFeatureClick` 不再调用 `centerOnFeature`，避免大量标签时的卡顿。
2.  **缓存布局数据**：在 `worker.onmessage` 中缓存布局后的标签数据。
    ```javascript
    cachedLayoutTags = tags;
    ```
3.  **快速查找**：`centerOnFeature` 使用缓存数组而非遍历 DOM。
    ```javascript
    for (const tag of cachedLayoutTags) {
      if (Math.abs(tag.lon - targetCoords[0]) < 0.000001 && ...) {
        targetD = tag;
        break;
      }
    }
    ```
4.  **防抖处理**：高亮更新使用 `requestAnimationFrame` 防抖。
    ```javascript
    highlightDebounce = requestAnimationFrame(() => { ... });
    ```
5.  **动画优化**：超过 500 个标签时禁用过渡动画。
    ```javascript
    const useTransition = tags.length < 500;
    ```

### 2.6 地图拖拽修复

**技术栈**：deck.gl, OpenLayers

**实现逻辑**：

1.  **pointer-events 设置**：deck.gl canvas 保持 `pointer-events: none`。
    ```javascript
    deckContainer.style.cssText = `pointer-events: none; ...`;
    ```
2.  **事件转发**：通过 OpenLayers 的 `pointermove` 和 `singleclick` 事件调用 `deckInstance.pickObject()`。
3.  **canvas 确认**：在 `nextTick` 中确保 deck.gl 生成的 canvas 也是 `pointer-events: none`。

---

## 3. 遇到的问题与解决办法

### 问题 1：定位操作导致界面崩溃

- **现象**：几万个标签时，点击 POI 触发 `centerOnFeature` 会使浏览器卡死。
- **原因**：`centerOnFeature` 使用 `rootGroupRef.selectAll('text').each()` 遍历所有 DOM 元素，时间复杂度 O(n) 但 DOM 操作极慢。
- **解决**：
  1.  缓存布局数据 `cachedLayoutTags` 在内存中。
  2.  使用坐标匹配在内存数组中快速查找，不遍历 DOM。
  3.  移除 POI → 标签的定位动画（只保留橙色常亮）。

### 问题 2：POI 圆圈与五角星叠加显示

- **现象**：定位时，水蓝色五角星与红色圆圈同时显示。
- **原因**：deck.gl 的 ScatterplotLayer 没有过滤掉当前定位的 POI。
- **解决**：
  1.  在 `flyTo` 中记录 `currentLocatedPoi`。
  2.  在 `updateDeckLayers` 的 `data` 参数中过滤掉该 POI。
  3.  使用 OpenLayers 的 `locateLayer` 单独显示五角星。

### 问题 3：悬浮离开后标签高亮消失

- **现象**：点击 POI 后对应标签高亮，但鼠标离开 POI 后标签恢复原色。
- **原因**：只使用了一个 `hoveredFeatureId` 状态，鼠标离开时被清空。
- **解决**：
  1.  新增 `clickedFeatureId` 状态用于点击常亮。
  2.  `updateHighlight` 函数同时检查两个状态，点击优先级更高。

### 问题 4：搜索后标签重叠

- **现象**：使用搜索工具过滤后，标签之间出现碰撞重叠。
- **原因**：D3 的 key 函数使用 `originalIndex`，搜索后新旧数据的 key 冲突导致 DOM 元素错误复用。
- **解决**：使用更唯一的 key：`${d.name}-${d.lon?.toFixed(6)}-${d.lat?.toFixed(6)}`。

---

## 4. 文件修改清单

| 文件               | 修改内容                                                                                 |
| ------------------ | ---------------------------------------------------------------------------------------- |
| `App.vue`          | 新增 `clickedFeatureId` 状态；修改 `handleFeatureClick` 和 `handleFeatureLocate`         |
| `MapContainer.vue` | 热力图颜色和半径优化；新增 `locateLayer` 五角星图层；修改 `flyTo` 逻辑；过滤当前定位 POI |
| `TagCloud.vue`     | 新增 `clickedFeatureId` prop；优化 `updateHighlight` 函数；缓存布局数据                  |

---

## 5. 交互行为总结

| 操作       | 地图效果                | TagCloud 效果              |
| ---------- | ----------------------- | -------------------------- |
| 悬浮 POI   | -                       | 对应标签变橙色             |
| 离开 POI   | -                       | 标签恢复原色（除非已点击） |
| 点击 POI   | -                       | 对应标签**常亮**橙色       |
| 点击标签   | 飞向 POI + 水蓝色五角星 | 标签橙色高亮               |
| 第一次定位 | 缩放到 17 级            | -                          |
| 后续定位   | 只平移不缩放            | -                          |
